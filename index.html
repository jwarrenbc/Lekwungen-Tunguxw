<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>KÃì ∑…ôÃÅn…ôx ∑ L…ôkÃì ∑a≈ã…ôn T…ô≈ã…ôx ∑</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" crossorigin="" />

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js" crossorigin=""></script>

    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?callback=initMap&loading=async&key=AIzaSyBB1fytz06At5xyMegjdPbWZumotf8S__U"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: "BC Sans", Helvetica, Arial, sans-serif;
        }

        /* Tailwind resets image max-width, which breaks Leaflet tiles. This fixes it. */
        .leaflet-tile-pane img {
            max-width: none !important; 
        }
        /* Remove default styling from Leaflet popups to let Tailwind take over */
        .leaflet-popup-content-wrapper {
            padding: 0;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 320px !important; /* Fixed width for consistency */
        }
    </style>
</head>
<body>
    <div id="map" class="h-full w-full bg-[#333]"></div>
    
    <div id="info-box" class="absolute top-3 left-12 z-[1000] bg-white rounded-lg shadow-lg text-sm p-4">Loading map...</div>
    
    <a href="https://github.com/jwarrenbc/Lekwungen-Tunguxw/?tab=readme-ov-file#k%CC%93%CA%B7%C9%99%CC%81n%C9%99x%CA%B7-l%C9%99k%CC%93%CA%B7a%C5%8B%C9%99n-t%C9%99%C5%8B%C9%99x%CA%B7-seeing-lekwungen-land" target="_blank" class="absolute top-0 right-0 z-[1000] bg-white shadow-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors px-1">‚ÑπÔ∏è About</a>

    <script>
        const geojsonUrl = 'https://raw.githubusercontent.com/jwarrenbc/Lekwungen-Tunguxw/refs/heads/dev/data/L%C9%99k%CC%93%CA%B7a%C5%8B%C9%99n%20T%C9%99%C5%8B%C9%99x%CA%B7.geojson';
        let map;

        function initMap() {
            const infoBox = document.getElementById('info-box');
            infoBox.textContent = 'Loading GeoJSON data...';
            
             try {
                map = L.map('map', {
                    center: [48.428333, -123.364722], // Victoria, BC
                    zoom: 10,
                    zoomControl: false
                });
                
                L.control.zoom({
                    position: 'bottomright'
                }).addTo(map);

                /* Hide Leaflet attribution */
                map.attributionControl.setPrefix(false);
                
                const satelliteLayer = L.gridLayer.googleMutant({
                    type: 'satellite',
                    continuousWorld: false,
                    opacity: 1.0
                }).addTo(map);

                /* Google often? adds its own copyright attribution, so this is unnecessary: */
                /* map.attributionControl.setPrefix(false);
                map.attributionControl.addAttribution('Satellite images &copy; Google'); */
                
                loadGeoJSON();
            } catch (error) {
                console.error('ERROR during map initialization (initMap):', error);
                infoBox.textContent = 'Error initializing map. See console.';
                infoBox.style.backgroundColor = '#FFDDDD';
            }
        }

        async function loadGeoJSON() {
            const infoBox = document.getElementById('info-box');

            try {
                const response = await fetch(geojsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Successfully fetched data, now add it to the map
                const geoJsonLayer = L.geoJSON(data, {
                    filter: function(feature, layer) {
                        return !(feature.properties && feature.properties.category === "Douglas Treaties");
                    },
                    pointToLayer: function(feature, latlng) {
                        // Map category to emoji
                        const categoryEmojis = {
                            'village': 'üèòÔ∏è',
                            'fishing': 'üé£',
                            'river': 'üíß',
                            'mountain': '‚õ∞Ô∏è',
                            'default': 'üìç'
                        };
                        
                        const category = feature.properties?.category || 'default';
                        const emoji = categoryEmojis[category] || categoryEmojis['default'];
                        
                        // Create custom icon with emoji
                        const icon = L.divIcon({
                            html: emoji,
                            className: 'flex items-center justify-center text-2xl',
                            iconSize: [60, 60],
                            iconAnchor: [30, 30]
                        });
                        
                        return L.marker(latlng, { icon: icon });
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        
                        // Safely extract properties
                        const lekwungenName = props?.name || 'Not known';
                        const settlerName = props?.settlerName || 'None';
                        const audioUrl = props?.audio?.src;
                        const audioCopyright = props?.audio?.copyright;
                        const description = props?.description || '';
                        const sources = props?.sources;

                        // --- 1. Construct Audio Button HTML ---
                        let audioSectionHtml = '';
                        if (audioUrl) {
                            audioSectionHtml = `
                                <div class="bg-amber-50 rounded-lg p-3 mb-3 border border-amber-100 text-center">
                                    <button onclick="new Audio('${audioUrl}').play()" 
                                            class="bg-yellow-700 hover:bg-yellow-800 text-white text-sm font-bold py-2 px-4 rounded-full inline-flex items-center transition-colors shadow-sm">
                                        <span class="mr-2 text-lg">‚ñ∂</span> Hear It
                                    </button>`;
                                
                            if (audioCopyright) {
                                audioSectionHtml += `
                                    <div class="text-[10px] text-gray-400 mt-2">
                                        Audio recording ${audioCopyright}
                                    </div>`;
                            }

                            audioSectionHtml += `
                                </div>
                            `;
                        }

                        // --- 2. Construct Source List HTML ---
                        let sourcesHtml = '';
                        if (Array.isArray(sources) && sources.length > 0) {
                            const listItems = sources.map(source => `<li class="mb-1">${source}</li>`).join('');
                            sourcesHtml = `
                                <div class="mt-4 mb-1 flex items-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    <span class="mr-1 text-lg">üìö</span> Sources
                                </div>
                                <ul class="list-disc pl-5 text-xs text-gray-600 leading-relaxed">
                                    ${listItems}
                                </ul>
                            `;
                        }

                        // --- 3. Construct Share Your Knowledge link ---
                        let encodedCoordinates = '';
                        if (layer.getLatLng) {
                            // Point Marker
                            const latLng = layer.getLatLng();
                            lat = latLng.lat.toFixed(6);
                            lng = latLng.lng.toFixed(6);

                            encodedCoordinates = encodeURIComponent(`${latLng.lat.toFixed(6)},${latLng.lng.toFixed(6)}`);
                        }

                        const encodedLekwungenName = encodeURIComponent(lekwungenName);
                        const encodedSettlerName = encodeURIComponent(settlerName);
                        const shareKnowledgeUrl = `https://docs.google.com/forms/d/e/1FAIpQLSfldIttf1uNJy_MBc_3L6IYD70ILZ8ez_Wd-ZT39tuFEX3bIg/viewform?usp=pp_url&entry.654077265=${encodedLekwungenName}&entry.89063686=${encodedSettlerName}&entry.596989000=${encodedCoordinates}`;

                        // --- 4. Construct Final Popup Content ---
                        const popupContent = `
                            <!-- Header -->
                            <div class="bg-[#8C7853] text-white p-4">
                                <h3 class="text-2xl font-bold leading-tight">üìç ${lekwungenName}</h3>
                            </div>
                            
                            <!-- Body -->
                            <div class="p-4 bg-white">
                                ${audioSectionHtml}

                                <div class="mb-3 text-sm text-gray-700 leading-relaxed">
                                    ${description}
                                </div>

                                <!-- Settler Name -->
                                <div class="mb-1 flex items-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    üá¨üáß English Name
                                </div>
                                <div class="text-base text-gray-800 pl-6 mb-2 font-medium">
                                    ${settlerName}
                                </div>

                                ${sourcesHtml}
                            
                                <div class="pt-3 mt-4 border-t border-gray-200 flex justify-center">
                                    <a href="${shareKnowledgeUrl}" target="_blank">
                                        Gift Your Knowledge
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);
                const bounds = geoJsonLayer.getBounds();
                
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [20, 20] });
                    infoBox.textContent = 'Data loaded successfully!';
                } else {
                    infoBox.textContent = 'Data loaded, but no valid bounds found.';
                    console.warn('GeoJSON data loaded, but bounds are not valid.');
                }
                
                // Hide the info box after a few seconds if there are no errors
                setTimeout(() => {
                    infoBox.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error fetching or parsing GeoJSON:', error);
                infoBox.textContent = 'Error: Could not load GeoJSON data. Check URL and file format.';
                infoBox.style.backgroundColor = '#FFDDDD';
            }
        }
    </script>
</body>
</html>